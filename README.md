# QPE-FIT (Fast Inference with Timing)

This repository contains the code for `QPE-FIT`, a Bayesian parameter estimation tool to fit Quasi-Periodic Eruption (QPE) timings. Under the model assumption that QPEs are generated by an extreme mass-ratio inspiral (EMRI) orbiter colliding with the accretion disk around a massive black hole, QPE timings encode information about the EMRI-disk system, and in principle, can be used to learn their underlying parameters. The current version performs Nested Sampling for parameter inference; previous iterations (including the one describe in the arXiv paper) used Markov Chain Monte Carlo (MCMC), and future versions will further iterate on the optimal sampling algorithms for the complex, high-dimensional parameters space of QPE timings.

Please email joheen@mit.edu with any requests, bug reports, or comments!

## Features

- **Efficient trajectory computation** with the post-Newtonian formalism for rapid inference
- **GPU acceleration** with CuPy for parallel computation during likelihood evaluations
- **Bayesian inference** with the UltraNest nested sampling library for robust parameter estimation

## Dependencies

- [KerrGeoPy](https://kerrgeopy.readthedocs.io/en/latest/) : For computing exact Kerr geodesic trajectories
- [UltraNest](https://johannesbuchner.github.io/UltraNest) : For nested sampling inference
- [CuPy](https://cupy.dev/) : For GPU-accelerated trajectory/residual computations
- [NumPy](https://numpy.org/) : For numerical computations
- [Corner](https://corner.readthedocs.io/) : For posterior distribution plots

## Module Overview

### `pn_trajectory.py`
Backend script implementing the post-Newtonian (PN) formalism for EMRI trajectories. Contains:
- GPU-accelerated computation of PN coefficients and Fourier-series trajectories following [Sago & Fujita 2015](https://arxiv.org/abs/1505.01600)
- Disk crossing detection with relativistic time delay corrections
- Timing residuals calculation for parameter fitting

#### `generate_timings.py`
Generate mock QPE timings for a given set of EMRI/disk parameters using exact Kerr geodesics (via KerrGeoPy)

**Command-line arguments:**
- `sma`: EMRI semimajor axis (gravitational radii $R_g$)
- `ecc`: EMRI eccentricity
- `incl`: EMRI inclination (degrees)
- `phi_r0`: Initial radial phase (radians)
- `phi_theta0`: Initial polar phase (radians)
- `phi_phi0`: Initial azimuthal phase (radians)
- `spin`: MBH spin parameter ($\chi_\bullet$)
- `logMbh`: log(MBH mass) (solar masses)
- `theta_obs`: Observer viewing angle (degrees)
- `theta_d`: Disk inclination angle (degrees)
- `P_d`: Disk precession period (multiples of EMRI orbital period)
- `phi_d`: Initial disk azimuthal phase (radians)
- `windows`: Observation windows (in seconds, as a 2D array)
- `timing_file`: Output file for QPE timings
- `window_file`: Output file for observation windows

#### `ns.py`
Perform nested sampling inference on QPE timings to estimate system parameters.

**Command-line arguments:**
- `output_dir`: Directory for output files and logs
- `timing_file`: File containing QPE timings (one per line, in seconds, .txt format)
- `window_file`: File containing observation windows (one space-separated start/stop pair per line, .txt format)
- `error_file`: File containing timing uncertainties (one per line, in seconds, .txt format)
- `dt`: Time step resolution for trajectory computation (in seconds)

**Inferred Parameters:**
The script fits for 12 parameters:
- `a`: EMRI semimajor axis (ideally >50 $R_g$)
- `e`: EMRI eccentricity (ideally <0.5)
- `i`: EMRI inclination (0-180°)
- `phi_r0`: Initial EMRI radial phase (0-2π radians)
- `phi_theta0`: Initial EMRI longitudinal phase (0-2π radians)
- `phi_phi0`: Initial EMRI azimuthal phase (0-2π radians)
- `chi_bullet`: MBH spin (0-0.998)
- `log M_bullet`: log(MBH mass) (solar masses)
- `theta_obs`: Observer viewing angle (0-2π radians)
- `theta_disk`: Disk inclination (0-90°)
- `T_disk/P_orb`: Ratio of disk precession period to EMRI orbital period
- `phi_disk`: Initial disk azimuthal phase (0-2π radians)

**Outputs:**
- Nested sampling chain and evidence in `output_dir`
- Parameter estimates with uncertainties (printed to console)
- Corner plot saved as `corner.png`

## Example Workflow

Here's a complete end-to-end example that:
1. Generates mock timing data for a specific EMRI-disk system
2. Performs parameter inference using nested sampling
3. Analyzes the results

```bash
# Step 1: Generate mock QPE timings
# EMRI/MBH: a=100 Rg, e=0.15, i=45°, spin=0.9, M_BH=10^5.8 M_sun
# Disk: 15° inclination, 500 P_orb precession period
# Two 100 ks observation windows separated by a 400 ks gap
python generate_timings.py 100 0.15 45 0 0 0 0.9 5.8 30 15 500 0 "[[0,100000],[500000,600000]]" timings.txt windows.txt

# Step 2: Add realistic timing uncertainties (example: 100s errors)
python -c "import numpy as np; t=np.loadtxt('timings.txt'); \
    np.savetxt('errors.txt', np.full(len(t), 100.0))"

# Step 3: Run nested sampling inference
# Using 10s time resolution for trajectory computation
python ns.py output_ns/ timings.txt windows.txt errors.txt 10

# Step 4: Results will be in output_ns/ directory
# - corner.png: posterior distribution plot
# - Console output: parameter estimates with uncertainties
```
From here, you can follow the [UltraNest tutorials](https://johannesbuchner.github.io/UltraNest/using-ultranest.html) for analyzing the posteriors!

## Citation

If you use QPE-FIT in your research, please cite [this paper](https://arxiv.org/abs/2508.20162)
