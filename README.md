### QPE-FIT (Fast Inference with Timing)

This repository contains the code for `QPE-FIT`, a Bayesian parameter estimation tool to fit Quasi-Periodic Eruption (QPE) timings. Under the model assumption that QPEs are generated by an extreme mass-ratio inspiral (EMRI) orbiter colliding with the accretion disk around a massive black hole, QPE timings encode information about the EMRI-disk system, and in principle, can be used to learn their underlying parameters. In the current version of `QPE-FIT`, PE is performed with Markov Chain Monte Carlo (MCMC), though there are future plans to explore other algorithms.

Dependencies:
- [KerrGeoPy](https://kerrgeopy.readthedocs.io/en/latest/) : to compute Kerr geodesic trajectories
- [emcee](https://emcee.readthedocs.io/en/stable/) : for MCMC sampling
- [CuPy](https://cupy.dev/) : for GPU-acceleration

The relevant scripts included, with a listing of required keyword arguments, are:

`generate_timings.py` : generate a set of mock QPE timings for a choice of EMRI/disk parameters
- $a$: EMRI semimajor axis ($R_g$/gravitational radii)
- $e$: EMRI eccentricity
- $i$: EMRI inclination (degrees)
- $a_\bullet$: MBH spin
- $M_\bullet$: log(MBH mass) (solar)
- $\theta_{\rm obs}$: Observer viewing angle (radians)
- $\theta_{\rm disk}$: Disk inclination angle (degrees)
- $T_{\rm disk}$: Disk precession period (multiples of EMRI orbital period)
- `windows`: Observation windows (seconds)
- `timing_file`: Output file to store QPE timings
- `window_file`: Output file to store observation windows (this is a helper file to pass the info along to the MCMC scripts)

`mcmc_fixedphase.py` : perform MCMC inference on a set of QPE timings
- `output_file`: emcee backend file (.h5 file to store the output chain)
- `timing_file`: file containing QPE timings (.dat file as generated by the previous script)
- `window_file`: file containing obvservation windows (.dat file as generated by the previous script)
- `nsteps`: number of MCMC steps to run
- `nwalkers`: number of parallel walkers to include
- `dt`: time step resolution for trial parameter trajectories (seconds)

`read_chain.py` : read the output chain and produce a corner plot of the top $k$ highest-likelihood samples
- `output_file`: emcee backend file from previous run (.h5 format)
- `topk`: retain the top $k$ log-likelihood samples

```
python generate_timings.py 100 0.1 60 0.998 5 0.785 10 20 [[0,100000],[500000,600000]] timings.dat windows.dat
python mcmc_fixedphase.py output_chain.h5 timings.dat errors.dat windows.dat 100000 1000 10
python read_chain.py output_chain.h5 100000
```

The first script calculates the exact trajectory of an orbiting body with $a=100R_g$, $e=0.1$, $i=60^\circ$, $a_\bullet=0.998$, $M_\bullet=10^5M_\odot$, for an observer inclined at $\pi/4$ radians and an accretion disk inclined at $10^\circ$ undering nodal precession with a period of $T_{\rm disk}=20P_{\rm orb}$. The trajectory is computed using KerrGeoPy with 10-second time resolution, then compute its disk-crossing times to store into `timings.dat`. These calculations are only made for the time intervals specified in `windows.dat` (so in this example, we have two 100 kilosecond observations separated by a 400 kilosecond gap).

The second script runs MCMC parameter estimation using the QPE timings stored in `timings.dat`. In addition to the 8 free parameters passed into `generate_timings.py`, there are two further ones: $\phi_{\rm disk}$, which accounts for an initial disk azimuthal phase offset; and $t_0$, which allows an overall EMRI-disk system phase argument to uniformly shift the timings. For the purposes of generating a mock trajectory, these phase arguments are both set to zero, but they are important to let vary when fitting to real data. Note that the prior range of $t_0$ can be tricky to define, and should be set on a case-by-case basis; typically, allowing to span a range equal to about one QPE recurrence time is a good idea.

The third script reads the results stored in `output_chain.h5` and picks out the 100,000 highest-likelihood samples, then produces a corner plot from this posterior.

NB: this code sets the EMRI radial/azimuthal/polar initial phases all to zero (hence the suffix `_fixedphase`). The radial and polar phases are not important for the short timescales, modest eccentricities, and large orbital radii considered here, and the azimuthal initial phase is equivalent to including the $t_0$ parameter.
