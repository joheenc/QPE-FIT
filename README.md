# QPE-FIT (Fast Inference with Timing)

This repository contains the code for `QPE-FIT`, a Bayesian parameter estimation tool to fit Quasi-Periodic Eruption (QPE) timings. Under the model assumption that QPEs are generated by an extreme mass-ratio inspiral (EMRI) orbiter colliding with the accretion disk around a massive black hole, QPE timings encode information about the EMRI-disk system, and in principle, can be used to learn their underlying parameters. The current version performs paremeter inference via [nested sampling](https://en.wikipedia.org/wiki/Nested_sampling_algorithm) using [UltraNest](https://johannesbuchner.github.io/UltraNest); previous iterations (including the one described in the [original paper](https://arxiv.org/abs/2508.20162)) used Markov Chain Monte Carlo.

Please email joheen@mit.edu with any requests, bug reports, or comments!

## Installation

```bash
conda create --name myenv python=3.12
conda activate myenv
conda install pip

# CPU only
pip install qpe-fit

# With GPU support (requires CUDA)
pip install qpe-fit[gpu]
```
The current version of QPE-FIT was only tested on CuPy/CUDA v12, which supports Python 3.8-3.12 (hence the pickiness regarding python version above). If you need a different CuPy version, ping me and I'll try to update the package accordingly.

## Dependencies

- [UltraNest](https://johannesbuchner.github.io/UltraNest) : For nested sampling inference
- [CuPy](https://cupy.dev/) : For GPU-accelerated trajectory/residual computations (optional)
- [NumPy](https://numpy.org/) : For numerical computations
- [Corner](https://corner.readthedocs.io/) : For posterior distribution plots
- [h5py](https://www.h5py.org/) : For HDF5 file I/O

## Command Overview

### `qpe-gen`
Generate mock QPE timings for a given set of EMRI/disk parameters using exact Kerr geodesics.

**Usage:**
```bash
qpe-gen --params params.json --windows windows.txt --output-timings timings.txt --output-windows windows_out.txt
```

**Arguments:**
- `--params`: JSON file with orbital parameters
- `--windows`: Observation windows file (start/stop pairs in seconds)
- `--output-timings`: Output file for QPE timings
- `--output-windows`: Output file for observation windows
- `--dt`: Time step resolution (default: 10s)
- `--one-per-orbit`: Flag to generate only one QPE per orbit (not two)

### `qpe-fit`
Perform nested sampling inference on QPE timings to estimate system parameters with post-Newtonian trajectories.

**Usage:**
```bash
qpe-fit --gpu
```

**Arguments:**
| Argument | Default | Description |
|----------|---------|-------------|
| `--output` | `output` | Sampling output directory |
| `--timings` | `timings.txt` | .txt file containing QPE timings (one per line, in seconds) |
| `--windows` | `windows.txt` | .txt file containing observation windows (one start-stop pair per line separated by a space, in seconds) |
| `--errors` | `errors.txt` | .txt file containing QPE timing errors (one per line, in seconds) |
| `--priors` | `priors.json` | .json file containing sampling priors |
| `--dt` | `10.0` | Time step size for likelihood evaluations (seconds) |
| `--gpu` | `False` | Flag to use GPU-accelerated likelihood evaluation |
| `--stepsampler` | `slice` | Step sampler: `none`, `slice`, `harm`, `rwalk` |
| `--direction` | `region` | Direction function: `region`, `random`, `mixture`, `cube` |
| `--region` | `simple` | Region class: `mlfriends`, `simple`, `ellipsoid` |
| `--popsize` | `256` | Number of walkers for step sampling |
| `--nsteps` | `256` | Number of steps for step sampling |
| `--nlive` | `600` | Minimum number of live points |
| `--dkl` | `0.5` | Target posterior uncertainty (KL divergence in nats) |
| `--frac-remain` | `0.01` | Integrate until this fraction of the integral remains |
| `--min-ess` | `400` | Minimum effective sample size |
| `--one-per-orbit` | `False` | Flag to generate only one QPE per orbit (not two) |

**Inferred Parameters:**
The script fits for 12 parameters:
- `sma`: EMRI semimajor axis (gravitational radii $R_g$)
- `e`: EMRI eccentricity
- `incl`: EMRI inclination (degrees)
- `phi_r0`: Initial EMRI radial phase (radians)
- `phi_theta0`: Initial EMRI polar phase (radians)
- `phi_phi0`: Initial EMRI azimuthal phase (radians)
- `spin`: MBH spin parameter (0-0.998)
- `logMbh`: log(MBH mass / solar masses)
- `theta_obs`: Observer viewing angle (radians)
- `theta_d`: Disk inclination (degrees)
- `P_d`: Disk precession period (multiples of EMRI orbital period)
- `phi_d`: Initial disk azimuthal phase (radians)

## Example Workflow

```bash
# Step 1: Create parameter file (params.json)
cat > params.json << EOF
{
    "sma": 100, "e": 0.15, "incl": 45,
    "phi_r0": 0, "phi_theta0": 1, "phi_phi0": 2,
    "spin": 0.9, "logMbh": 5.8, "theta_obs": 0.5,
    "theta_d": 15, "P_d": 500, "phi_d": 0
}
EOF

# Step 2: Create observation windows (two 100ks windows)
echo "0 100000
500000 600000" > windows.txt

# Step 3: Generate mock QPE timings
qpe-gen --params params.json --windows windows.txt --output-timings timings.txt

# Step 4: Create mock timing uncertainties (100s errors)
awk '{print 100}' timings.txt > errors.txt

# Step 5: Create prior file (priors.json)
cat > priors.json << EOF
{
    "sma": {"bounds": [50, 200], "wrapped": false},
    "e": {"bounds": [0.0, 0.3], "wrapped": false},
    "incl": {"bounds": [0, 90], "wrapped": false},
    "phi_r0": {"bounds": [0, 6.283], "wrapped": true},
    "phi_theta0": {"bounds": [0, 6.283], "wrapped": true},
    "phi_phi0": {"bounds": [0, 6.283], "wrapped": true},
    "spin": {"bounds": [0.5, 0.998], "wrapped": false},
    "logMbh": {"bounds": [5.5, 6.0], "wrapped": false},
    "theta_obs": {"bounds": [0, 3.142], "wrapped": true},
    "theta_d": {"bounds": [0, 30], "wrapped": false},
    "P_d": {"bounds": [300, 700], "wrapped": false},
    "phi_d": {"bounds": [0, 6.283], "wrapped": true}
}
EOF

# Step 6: Run nested sampling inference (with GPU)
qpe-fit --gpu

# Results will be the output/ directory
```
Of course, if you have _real_ QPE timing data you want to fit, you can skip Steps 1-4.
From here, you can follow the (excellent and informative) [UltraNest tutorials](https://johannesbuchner.github.io/UltraNest/using-ultranest.html) to interpret the results!

## Citation

If you use QPE-FIT in your research, please cite [J. Chakraborty & L.V. Drummond et al., ApJ, 992, 120 (2025)](https://ui.adsabs.harvard.edu/abs/2025ApJ...992..120C/abstract) and the [UltraNest paper](https://ui.adsabs.harvard.edu/abs/2021JOSS....6.3001B/abstract)!
